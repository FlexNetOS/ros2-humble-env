
# =============================================================================
# State & Storage Services - Layer 10
# =============================================================================
# P0-005: Redis - High-performance cache and state management
# P1-006: MinIO - S3-compatible object storage for artifacts
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Redis - Cache & State Management
  # ---------------------------------------------------------------------------
  # Fast in-memory data store for:
  # - Session state
  # - Rate limiting counters
  # - Hot response caching
  # - Prompt cache policy
  # - Agent memory (hot tier)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7.4-alpine
    container_name: redis-server
    ports:
      - "6379:6379"
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - redis_data:/data
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2gb
        reservations:
          memory: 512mb

  # ---------------------------------------------------------------------------
  # MinIO - Object Storage (S3-compatible)
  # ---------------------------------------------------------------------------
  # Distributed object storage for:
  # - Model artifacts
  # - Agent outputs
  # - Training data
  # - Logs and metrics
  # - Vector embeddings (persistent tier)
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:RELEASE.2024-12-18T13-15-44Z
    container_name: minio-server
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BROWSER_REDIRECT_URL: http://localhost:9001
      MINIO_PROMETHEUS_AUTH_TYPE: public
      MINIO_PROMETHEUS_URL: http://prometheus:9090
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4gb
        reservations:
          memory: 1gb

  # ---------------------------------------------------------------------------
  # MinIO Client (mc) - Command-line tool for MinIO operations
  # ---------------------------------------------------------------------------
  # Sidecar container for MinIO administration
  # Usage: docker compose -f docker-compose.state.yml exec mc mc ls local
  # ---------------------------------------------------------------------------
  mc:
    image: minio/mc:RELEASE.2024-12-18T13-13-44Z
    container_name: minio-client
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin};
      mc mb --ignore-existing local/aria-artifacts;
      mc mb --ignore-existing local/aria-models;
      mc mb --ignore-existing local/aria-logs;
      mc mb --ignore-existing local/aria-vectors;
      mc anonymous set download local/aria-models;
      echo 'MinIO initialized with buckets: aria-artifacts, aria-models, aria-logs, aria-vectors';
      tail -f /dev/null
      "
    networks:
      - agentic-network
    restart: unless-stopped

volumes:
  redis_data:
    driver: local
  minio_data:
    driver: local

networks:
  agentic-network:
    external: true
