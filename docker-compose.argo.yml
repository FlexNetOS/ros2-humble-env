
# Note: Argo CD is designed for Kubernetes and doesn't have official Docker Compose support.
# This configuration provides a development/testing environment using k3s in Docker.
# For production, deploy to a real Kubernetes cluster.

services:
  # K3s - Lightweight Kubernetes for local development
  k3s-server:
    image: rancher/k3s:v1.31.4-k3s1
    container_name: k3s-server
    command: server --disable traefik --disable servicelb --disable metrics-server
    privileged: true
    environment:
      - K3S_TOKEN=${K3S_TOKEN:-changeme}
      - K3S_KUBECONFIG_OUTPUT=/output/kubeconfig.yaml
      - K3S_KUBECONFIG_MODE=666
    volumes:
      - k3s-server:/var/lib/rancher/k3s
      - ./data/k3s/kubeconfig:/output
    ports:
      - "6443:6443"  # Kubernetes API
      - "8080:8080"  # Argo CD UI (after installation)
      - "8081:8081"  # Argo Rollouts Dashboard
      - "2746:2746"  # Argo Workflows UI
    networks:
      - agentic-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "k3s", "kubectl", "get", "nodes"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Argo CD installer (runs once to install Argo CD into k3s)
  argocd-installer:
    image: bitnami/kubectl:1.32.1
    container_name: argocd-installer
    depends_on:
      k3s-server:
        condition: service_healthy
    volumes:
      - ./data/k3s/kubeconfig:/root/.kube
      - ./scripts/install-argocd.sh:/install-argocd.sh:ro
    environment:
      - KUBECONFIG=/root/.kube/kubeconfig.yaml
    command: /bin/bash /install-argocd.sh
    networks:
      - agentic-network
    restart: on-failure

volumes:
  k3s-server:

networks:
  agentic-network:
    external: true
    name: agentic-network

# =============================================================================
# ARIA Infrastructure - Argo Stack (P1-011 Implementation)
# =============================================================================
# This stack includes:
# - Argo CD: GitOps continuous delivery
# - Argo Rollouts: Progressive delivery (canary, blue-green)
# - Argo Workflows: Container-native workflow engine
#
# Quick Start:
#   1. docker-compose -f docker-compose.argo.yml up -d
#   2. ./scripts/setup-argo-workflows.sh
#   3. Access UIs:
#      - Argo CD: https://localhost:30443
#      - Argo Rollouts: http://localhost:8081
#      - Argo Workflows: http://localhost:2746
# =============================================================================

# Usage:
# 1. Create required directories:
#    mkdir -p data/k3s/kubeconfig scripts
#
# 2. Start k3s and install Argo stack:
#    docker-compose -f docker-compose.argo.yml up -d
#
# 3. Wait for installation (check logs):
#    docker-compose -f docker-compose.argo.yml logs -f argocd-installer
#
# 4. Configure Argo Workflows (RECOMMENDED):
#    export KUBECONFIG=./data/k3s/kubeconfig/kubeconfig.yaml
#    ./scripts/setup-argo-workflows.sh
#
# 5. Get Argo CD admin password:
#    export KUBECONFIG=./data/k3s/kubeconfig/kubeconfig.yaml
#    kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
#
# =============================================================================
# ARGO CD - GitOps Continuous Delivery
# =============================================================================
# Access: https://localhost:30443
# Username: admin
# Password: (see step 5 above)
#
# Port forward alternative:
#   kubectl port-forward svc/argocd-server -n argocd 8080:443
#   Access: https://localhost:8080
#
# Install Argo CD CLI:
#   curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
#   sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
#   argocd login localhost:30443 --username admin --password <password> --insecure
#
# GitOps Workflow:
#   argocd app create myapp --repo https://github.com/your-org/your-repo \
#     --path manifests --dest-server https://kubernetes.default.svc \
#     --dest-namespace default
#   argocd app sync myapp
#   argocd app get myapp
#
# =============================================================================
# ARGO ROLLOUTS - Progressive Delivery
# =============================================================================
# Features: Canary deployments, Blue-green deployments, Analysis runs
#
# Access dashboard:
#   kubectl port-forward svc/argo-rollouts-dashboard -n argo-rollouts 3100:3100
#   Access: http://localhost:3100
#
# Install Argo Rollouts kubectl plugin:
#   curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
#   chmod +x kubectl-argo-rollouts-linux-amd64
#   sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
#
# Common commands:
#   kubectl argo rollouts list rollouts -n default
#   kubectl argo rollouts get rollout myapp -n default
#   kubectl argo rollouts promote myapp -n default
#
# =============================================================================
# ARGO WORKFLOWS - Container-Native Workflow Engine
# =============================================================================
# Features: DAG-based workflows, CI/CD pipelines, Data processing
#
# Access UI:
#   Direct: http://localhost:2746
#   NodePort: http://localhost:32746
#   Port forward: kubectl port-forward svc/argo-server -n argo 2746:2746
#
# Install Argo CLI:
#   curl -sLO https://github.com/argoproj/argo-workflows/releases/latest/download/argo-linux-amd64.gz
#   gunzip argo-linux-amd64.gz
#   chmod +x argo-linux-amd64
#   sudo mv argo-linux-amd64 /usr/local/bin/argo
#
# Workflow operations:
#   argo list -n argo                          # List all workflows
#   argo submit workflow.yaml -n argo          # Submit workflow
#   argo watch <workflow-name> -n argo         # Watch workflow execution
#   argo logs <workflow-name> -n argo          # View workflow logs
#   argo delete <workflow-name> -n argo        # Delete workflow
#
# Submit example workflows:
#   kubectl create -f manifests/argo-workflows/templates/hello-world.yaml -n argo
#   argo submit manifests/argo-workflows/templates/ci-pipeline.yaml -n argo
#   argo submit manifests/argo-workflows/templates/ml-pipeline.yaml -n argo
#
# Documentation:
#   See: manifests/argo-workflows/README.md
#
# =============================================================================
# VERIFICATION & MONITORING
# =============================================================================
# Check all components:
#   kubectl get all -n argocd
#   kubectl get all -n argo-rollouts
#   kubectl get all -n argo
#
# View logs:
#   kubectl logs -n argocd deployment/argocd-server
#   kubectl logs -n argo-rollouts deployment/argo-rollouts
#   kubectl logs -n argo deployment/workflow-controller
#   kubectl logs -n argo deployment/argo-server
#
# Check workflow templates:
#   kubectl get workflowtemplate -n argo
#
# Monitor workflows:
#   kubectl get workflows -n argo --watch
