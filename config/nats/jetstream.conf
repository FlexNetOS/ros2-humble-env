# =============================================================================
# NATS JetStream Configuration
# P2-002: Configure NATS JetStream for Message Persistence
# =============================================================================
# This configuration defines streams for different message types with
# appropriate retention policies, replication settings, and consumer configs.
# =============================================================================

# Stream definitions are created via init-jetstream.sh script
# This file documents the stream configurations for reference

# -----------------------------------------------------------------------------
# WORKFLOWS Stream
# -----------------------------------------------------------------------------
# Purpose: Workflow execution events and state transitions
# Subjects: workflows.>
# Retention: WorkQueue (messages removed after ack)
# Max Age: 7 days (fallback for unacked messages)
# Max Messages: 1,000,000
# Max Bytes: 10GB
# Replicas: 1 (increase for HA)
# Storage: File-based for durability

# Consumer: workflow-processor
# - Durable consumer for reliable processing
# - Ack Wait: 30s (time to process before redelivery)
# - Max Deliver: 3 (max redelivery attempts)
# - Filter Subject: workflows.* (all workflow events)

# -----------------------------------------------------------------------------
# EVENTS Stream
# -----------------------------------------------------------------------------
# Purpose: System and application events for observability
# Subjects: events.>
# Retention: Limits (keep based on size/age/count)
# Max Age: 30 days
# Max Messages: 10,000,000
# Max Bytes: 50GB
# Replicas: 1
# Storage: File-based

# Consumer: event-logger
# - Push-based consumer for real-time event processing
# - Deliver All (process all events from stream start)
# - Rate Limit: 1000 msgs/sec

# Consumer: event-analytics
# - Pull-based consumer for batch analytics
# - Filter Subject: events.metrics.> (only metric events)
# - Max Ack Pending: 100

# -----------------------------------------------------------------------------
# LOGS Stream
# -----------------------------------------------------------------------------
# Purpose: Application and system logs
# Subjects: logs.>
# Retention: Limits (size and age constrained)
# Max Age: 14 days
# Max Messages: 50,000,000
# Max Bytes: 100GB
# Replicas: 1
# Storage: File-based
# Discard: Old (discard oldest when limits reached)

# Consumer: log-aggregator
# - Durable consumer for log collection
# - Ack Wait: 10s
# - Max Deliver: 2

# -----------------------------------------------------------------------------
# COMMANDS Stream
# -----------------------------------------------------------------------------
# Purpose: Agent commands and control messages
# Subjects: commands.>
# Retention: WorkQueue
# Max Age: 1 hour (commands should be processed quickly)
# Max Messages: 100,000
# Max Bytes: 1GB
# Replicas: 1
# Storage: File-based

# Consumer: command-executor
# - Durable consumer with exactly-once delivery
# - Ack Wait: 60s (longer for complex commands)
# - Max Deliver: 1 (no retries for idempotency)
# - Filter Subject: commands.* (all commands)

# -----------------------------------------------------------------------------
# TELEMETRY Stream
# -----------------------------------------------------------------------------
# Purpose: Metrics, traces, and monitoring data
# Subjects: telemetry.>
# Retention: Limits
# Max Age: 7 days
# Max Messages: 100,000,000
# Max Bytes: 200GB
# Replicas: 1
# Storage: File-based
# Discard: Old

# Consumer: metrics-collector
# - Pull-based consumer for Prometheus/OpenTelemetry
# - Batch Size: 1000
# - Max Ack Pending: 10000

# -----------------------------------------------------------------------------
# NOTIFICATIONS Stream
# -----------------------------------------------------------------------------
# Purpose: User and system notifications
# Subjects: notifications.>
# Retention: Interest (keep while consumers exist)
# Max Age: 24 hours
# Max Messages: 1,000,000
# Max Bytes: 5GB
# Replicas: 1
# Storage: File-based

# Consumer: notification-dispatcher
# - Push-based consumer for immediate delivery
# - Ack Wait: 15s
# - Max Deliver: 5 (retry for delivery failures)

# =============================================================================
# Configuration Notes
# =============================================================================
# - All streams use file-based storage for durability across restarts
# - Retention policies balance between data persistence and storage costs
# - Replication set to 1 for single-node setups (increase for clusters)
# - Consumer configurations support different processing patterns:
#   * WorkQueue: For task distribution and load balancing
#   * Limits: For event sourcing and audit logs
#   * Interest: For pub/sub with temporary retention
# - Use init-jetstream.sh to create/update these stream definitions
# =============================================================================
