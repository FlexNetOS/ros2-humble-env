
# =============================================================================
# Messaging & Workflow Services
# =============================================================================
# NATS: High-performance event bus for agent communication
# Temporal: Durable workflow orchestration for long-running tasks
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # NATS Server - Event Bus
  # ---------------------------------------------------------------------------
  nats:
    image: nats:2.10.24-alpine
    container_name: nats-server
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # HTTP monitoring
      - "6222:6222"   # Cluster routing
    command: >
      --name nats-main
      --http_port 8222
      --jetstream
      --store_dir /data
    volumes:
      - nats_data:/data
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Temporal Server - Durable Workflows
  # ---------------------------------------------------------------------------
  temporal:
    image: temporalio/auto-setup:1.26.2
    container_name: temporal-server
    ports:
      - "7233:7233"   # gRPC frontend
      - "7234:7234"   # gRPC matching
      - "7235:7235"   # gRPC history
      - "7239:7239"   # HTTP metrics
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=${TEMPORAL_DB_USER:-temporal}
      - POSTGRES_PWD=${TEMPORAL_DB_PASSWORD:-changeme}
      - POSTGRES_SEEDS=temporal-db
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml
    depends_on:
      temporal-db:
        condition: service_healthy
    volumes:
      - ./config/temporal:/etc/temporal/config/dynamicconfig
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "temporal", "workflow", "list", "--namespace", "default"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  temporal-db:
    image: postgres:17.2-alpine
    container_name: temporal-db
    environment:
      POSTGRES_USER: ${TEMPORAL_DB_USER:-temporal}
      POSTGRES_PASSWORD: ${TEMPORAL_DB_PASSWORD:-changeme}
      POSTGRES_DB: ${TEMPORAL_DB_NAME:-temporal}
    volumes:
      - temporal_db_data:/var/lib/postgresql/data
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${TEMPORAL_DB_USER:-temporal}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  temporal-ui:
    image: temporalio/ui:2.34.0
    container_name: temporal-ui
    ports:
      - "8088:8080"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    depends_on:
      - temporal
    networks:
      - agentic-network
    restart: unless-stopped

  temporal-admin-tools:
    image: temporalio/admin-tools:1.26.2
    container_name: temporal-admin
    stdin_open: true
    tty: true
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
    depends_on:
      - temporal
    networks:
      - agentic-network

volumes:
  nats_data:
    driver: local
  temporal_db_data:
    driver: local

networks:
  agentic-network:
    external: true
