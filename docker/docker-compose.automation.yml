
# =============================================================================
# Automation & Policy Services
# =============================================================================
# n8n: Workflow automation and connector platform
# OPA: Open Policy Agent for fine-grained authorization
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # n8n - Workflow Automation
  # ---------------------------------------------------------------------------
  n8n:
    image: n8nio/n8n:1.73.1
    container_name: n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-changeme}
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=UTC
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=n8n-db
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME:-n8n}
      - DB_POSTGRESDB_USER=${N8N_DB_USER:-n8n}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD:-changeme}
      # AI Integration
      - N8N_AI_ENABLED=true
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      n8n-db:
        condition: service_healthy
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  n8n-db:
    image: postgres:17.2-alpine
    container_name: n8n-db
    environment:
      POSTGRES_USER: ${N8N_DB_USER:-n8n}
      POSTGRES_PASSWORD: ${N8N_DB_PASSWORD:-changeme}
      POSTGRES_DB: ${N8N_DB_NAME:-n8n}
    volumes:
      - n8n_db_data:/var/lib/postgresql/data
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${N8N_DB_USER:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # OPA - Open Policy Agent
  # ---------------------------------------------------------------------------
  opa:
    image: openpolicyagent/opa:0.71.0-rootless
    container_name: opa
    ports:
      - "8181:8181"
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=info"
      - "--log-format=json"
      - "/policies"
    volumes:
      - ./config/opa/policies:/policies:ro
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8181/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # OPA Bundle Server (optional - for policy distribution)
  # ---------------------------------------------------------------------------
  opa-bundle-server:
    image: nginx:1.27.3-alpine
    container_name: opa-bundle-server
    ports:
      - "8383:80"
    volumes:
      - ./config/opa/bundles:/usr/share/nginx/html:ro
    networks:
      - agentic-network
    restart: unless-stopped

volumes:
  n8n_data:
    driver: local
  n8n_db_data:
    driver: local

networks:
  agentic-network:
    external: true
