# =============================================================================
# Database CI/CD Layer - Bytebase
# =============================================================================
# P3-002: Bytebase - Database CI/CD and version control for SQL migrations
# =============================================================================
#
# Usage:
#   docker network create agentic-network 2>/dev/null || true
#   docker compose -f docker-compose.bytebase.yml up -d
#
# Endpoints:
#   Bytebase Web UI: http://localhost:5678
#   Initial login: admin@bytebase.com / changeme
#
# Features:
#   - Database schema version control via Git
#   - SQL change review and approval workflows
#   - Database migration automation
#   - Change history and audit trails
#   - Multi-environment deployment (dev, staging, prod)
#   - GitOps integration for IaC
#   - Backup and recovery management
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Bytebase - Database CI/CD Platform
  # ---------------------------------------------------------------------------
  # https://www.bytebase.com/
  # Enterprise-grade database DevOps and CI/CD platform:
  # - SQL migration management and version control
  # - Change request workflows with approval gates
  # - Risk analysis and potential issue detection
  # - Schema synchronization across databases
  # - Database backup and recovery automation
  # - Audit logs and compliance reporting
  # - Integration with Git (GitHub, GitLab, etc.)
  # - Supports PostgreSQL, MySQL, MariaDB, MongoDB, Snowflake, BigQuery, etc.
  # ---------------------------------------------------------------------------
  bytebase:
    image: bytebase/bytebase:2.13.0
    container_name: bytebase
    ports:
      - "5678:5678"
    volumes:
      - bytebase-data:/var/opt/bytebase
    environment:
      # PostgreSQL metadata database for Bytebase itself
      # Bytebase stores its configuration, user data, and history in this database
      PG_URL: postgresql://postgres:changeme@postgres:5432/bytebase

      # Optional: Set data directory (default is /var/opt/bytebase)
      # BYTEBASE_DATA_DIR: /var/opt/bytebase

      # Optional: Enable debug mode for troubleshooting
      # BB_DEBUG: "true"

      # Port configuration (same as exposed port)
      BB_PORT: "5678"

      # External URL for external service integrations
      # Set this if Bytebase is accessed via a different host/port
      # BB_EXTERNAL_URL: http://bytebase.example.com:5678

    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2gb
          cpus: '1.0'
        reservations:
          memory: 512mb
          cpus: '0.5'

  # ---------------------------------------------------------------------------
  # PostgreSQL - Bytebase Metadata Database
  # ---------------------------------------------------------------------------
  # Stores Bytebase's internal configuration:
  # - User accounts and permissions
  # - Database connection configurations
  # - Change requests and approval histories
  # - Schema versions and migration history
  # - Audit logs and activity trails
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:17.2-alpine
    container_name: bytebase-postgres
    environment:
      POSTGRES_DB: bytebase
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: changeme
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8"
    volumes:
      - bytebase-postgres-data:/var/lib/postgresql/data
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d bytebase"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512mb
        reservations:
          memory: 256mb

# =============================================================================
# Volumes
# =============================================================================
volumes:
  bytebase-data:
    driver: local
  bytebase-postgres-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  agentic-network:
    external: true
    name: agentic-network
