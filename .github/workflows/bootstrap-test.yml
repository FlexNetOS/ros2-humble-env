name: Bootstrap End-to-End Test

on:
  push:
    branches: [main]
    paths:
      - 'bootstrap.sh'
      - 'bootstrap.ps1'
      - 'flake.nix'
      - 'flake.lock'
      - 'pixi.toml'
      - 'pixi.lock'
      - '.github/workflows/bootstrap-test.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  bootstrap-linux:
    name: Bootstrap Test (Linux x86_64)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Verify Nix installation
        run: |
          nix --version
          nix config show | grep experimental-features

      - name: Install dependencies via Nix
        run: |
          nix profile install nixpkgs#direnv
          nix profile install nixpkgs#nix-output-monitor
          nix profile install nixpkgs#git
          nix profile install nixpkgs#gh

      - name: Verify flake
        run: |
          nix flake check --no-build
          nix flake show

      - name: Build development shell
        run: |
          nix develop --command echo "Development shell is working"

      - name: Verify pixi is available
        run: |
          nix develop --command pixi --version

      - name: Run pixi install
        run: |
          nix develop --command pixi install

      - name: Verify ROS2 environment
        run: |
          nix develop --command pixi run python --version
          nix develop --command pixi run cmake --version

      - name: Test colcon availability
        run: |
          nix develop --command pixi run colcon --help | head -20

      - name: Test ROS2 commands
        run: |
          nix develop --command pixi run ros2 --help | head -20

  bootstrap-macos:
    name: Bootstrap Test (macOS)
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Verify Nix installation
        run: |
          nix --version
          nix config show | grep experimental-features

      - name: Install dependencies via Nix
        run: |
          nix profile install nixpkgs#direnv
          nix profile install nixpkgs#nix-output-monitor

      - name: Verify flake
        run: |
          nix flake check --no-build
          nix flake show

      - name: Build development shell
        run: |
          nix develop --command echo "Development shell is working"

      - name: Verify pixi is available
        run: |
          nix develop --command pixi --version

      - name: Run pixi install
        run: |
          nix develop --command pixi install

      - name: Verify environment tools
        run: |
          nix develop --command pixi run python --version
          nix develop --command pixi run cmake --version

  bootstrap-windows:
    name: Bootstrap Test (Windows - Syntax Check)
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate PowerShell script syntax
        shell: pwsh
        run: |
          $errors = $null
          $ast = [System.Management.Automation.Language.Parser]::ParseFile(
            "$env:GITHUB_WORKSPACE\bootstrap.ps1",
            [ref]$null,
            [ref]$errors
          )

          if ($errors.Count -gt 0) {
            Write-Host "PowerShell syntax errors found:" -ForegroundColor Red
            $errors | ForEach-Object { Write-Host $_.Message -ForegroundColor Red }
            exit 1
          }

          Write-Host "PowerShell script syntax is valid" -ForegroundColor Green

      - name: Check PowerShell best practices
        shell: pwsh
        run: |
          # Install PSScriptAnalyzer if not present
          if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
            Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          }

          # Run analysis
          $results = Invoke-ScriptAnalyzer -Path bootstrap.ps1 -Severity Error,Warning

          if ($results) {
            Write-Host "PSScriptAnalyzer findings:" -ForegroundColor Yellow
            $results | Format-Table -AutoSize

            # Only fail on errors, not warnings
            $errorCount = ($results | Where-Object { $_.Severity -eq 'Error' }).Count
            if ($errorCount -gt 0) {
              Write-Host "Found $errorCount error(s)" -ForegroundColor Red
              exit 1
            }
          }

          Write-Host "PowerShell script analysis passed" -ForegroundColor Green

      - name: Verify script help documentation
        shell: pwsh
        run: |
          # Check that help documentation exists
          $help = Get-Help .\bootstrap.ps1 -Full

          if (-not $help.Synopsis) {
            Write-Host "Warning: Script missing synopsis" -ForegroundColor Yellow
          }

          if (-not $help.Description) {
            Write-Host "Warning: Script missing description" -ForegroundColor Yellow
          }

          Write-Host "Script parameters:" -ForegroundColor Cyan
          $help.Parameters.Parameter | ForEach-Object {
            Write-Host "  -$($_.Name): $($_.Description.Text)"
          }

  bootstrap-script-test:
    name: Bootstrap Script Test (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - name: Make bootstrap script executable
        run: chmod +x bootstrap.sh

      - name: Run bootstrap script in CI mode
        run: |
          ./bootstrap.sh --ci --skip-shells
        env:
          # Suppress interactive prompts
          NIX_INSTALLER_NO_CONFIRM: "true"

      - name: Verify bootstrap completed successfully
        run: |
          # Source nix
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi

          # Verify installed tools
          nix --version
          direnv --version
          nom --version
          git --version
          gh --version

      - name: Verify development environment works
        run: |
          # Source nix
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          fi

          # Enter dev shell and verify
          nix develop --command pixi run ros2 --help | head -10
