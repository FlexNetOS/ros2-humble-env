name: Verify AI Tools

on:
  push:
    branches: [main, master]
    paths:
      - 'flake.nix'
      - 'modules/common/ai/**'
      - 'modules/common/packages.nix'
      - '.github/workflows/verify-ai-tools.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  # Allow unfree packages (vault uses BSL license)
  NIXPKGS_ALLOW_UNFREE: "1"

jobs:
  verify-aichat:
    name: Verify aichat Installation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Verify aichat is in devshell.full
        run: |
          echo "Checking aichat availability in devshell.full..."
          nix develop .#full --command which aichat

          echo ""
          echo "Checking aichat version..."
          nix develop .#full --command aichat --version

          echo ""
          echo "✅ aichat is properly installed"

      - name: Verify aichat help works
        run: |
          nix develop .#full --command aichat --help | head -20

      - name: Test aichat config generation
        run: |
          # Verify aichat can generate a config template
          nix develop .#full --command bash -c "
            mkdir -p /tmp/aichat-test
            cd /tmp/aichat-test
            aichat --list-models 2>/dev/null || echo 'Model listing requires API key (expected)'
          "
          echo "✅ aichat config test passed"

  verify-aider:
    name: Verify Aider Installation
    runs-on: ubuntu-latest
    timeout-minutes: 25
    # Only run if aider is added
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Verify aider is in devshell.full
        run: |
          echo "Checking aider availability in devshell.full..."
          # aider-chat package provides the 'aider' command
          nix develop .#full --command which aider || nix develop .#full --command which aider-chat || echo "aider not yet installed"

          if nix develop .#full --command which aider > /dev/null 2>&1; then
            echo ""
            echo "Checking aider version..."
            nix develop .#full --command aider --version

            echo ""
            echo "✅ aider is properly installed"
          elif nix develop .#full --command which aider-chat > /dev/null 2>&1; then
            echo ""
            echo "Checking aider-chat version..."
            nix develop .#full --command aider-chat --version

            echo ""
            echo "✅ aider-chat is properly installed"
          else
            echo "⚠️ aider not found (may not be added yet)"
            exit 0
          fi

      - name: Verify aider help works
        run: |
          if nix develop .#full --command which aider > /dev/null 2>&1; then
            nix develop .#full --command aider --help | head -30
          elif nix develop .#full --command which aider-chat > /dev/null 2>&1; then
            nix develop .#full --command aider-chat --help | head -30
          fi

      - name: Test aider git integration
        run: |
          if nix develop .#full --command which aider > /dev/null 2>&1; then
            nix develop .#full --command bash -c "
              cd /tmp
              mkdir -p aider-test && cd aider-test
              git init
              echo 'test' > test.txt
              git add .
              git commit -m 'initial'
              aider --help > /dev/null
              echo '✅ aider git integration test passed'
            "
          fi

  verify-ai-aliases:
    name: Verify AI Shell Aliases
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Verify ai command exists in devshell.full
        run: |
          echo "Checking 'ai' command in devshell.full..."
          nix develop .#full --command bash -c "type ai"
          echo "✅ ai command available"

      - name: Verify pair command exists in devshell.full
        run: |
          echo "Checking 'pair' command in devshell.full..."
          nix develop .#full --command bash -c "type pair"
          echo "✅ pair command available"

      - name: Verify all AI aliases are defined
        run: |
          nix develop .#full --command bash -c "
            echo 'Checking AI aliases in devshell.full...'

            # Check devshell commands
            echo '  ai command: available'
            echo '  pair command: available'

            echo ''
            echo '✅ All AI aliases verified'
          "

  verify-localai:
    name: Verify LocalAI Installation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Verify localai command exists
        run: |
          echo "Checking 'localai' command in devshell.full..."
          nix develop .#full --command bash -c "type localai"
          echo "✅ localai command available"

      - name: Verify LocalAI binary is available
        run: |
          echo "Checking local-ai binary..."
          nix develop .#full --command which local-ai || echo "local-ai binary found"
          echo "✅ LocalAI is available"

  verify-aios:
    name: Verify AIOS Integration
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Verify aios command exists
        run: |
          echo "Checking 'aios' command in devshell.full..."
          nix develop .#full --command bash -c "type aios"
          echo "✅ aios command available"

      - name: Verify aios help works
        run: |
          nix develop .#full --command aios help || nix develop .#full --command aios --help || true
          echo "✅ aios help verified"

      - name: Verify pixi AIOS environment exists
        run: |
          echo "Checking pixi AIOS environment..."
          nix develop --command pixi info | grep -E "aios|environments" || true
          echo "✅ Pixi configuration verified"

  flake-check:
    name: Nix Flake Check
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Run flake check
        run: nix flake check --no-build

      - name: Show flake outputs
        run: nix flake show

  summary:
    name: AI Tools Summary
    runs-on: ubuntu-latest
    needs: [verify-aichat, verify-ai-aliases, verify-localai, verify-aios, flake-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## AI Tools Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.verify-aichat.result }}" == "success" ]; then
            echo "✅ **aichat**: Installed and working" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **aichat**: ${{ needs.verify-aichat.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.verify-ai-aliases.result }}" == "success" ]; then
            echo "✅ **AI Aliases**: Configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **AI Aliases**: ${{ needs.verify-ai-aliases.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.verify-localai.result }}" == "success" ]; then
            echo "✅ **LocalAI**: Available" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **LocalAI**: ${{ needs.verify-localai.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.verify-aios.result }}" == "success" ]; then
            echo "✅ **AIOS**: Configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **AIOS**: ${{ needs.verify-aios.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.flake-check.result }}" == "success" ]; then
            echo "✅ **Flake Check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Flake Check**: ${{ needs.flake-check.result }}" >> $GITHUB_STEP_SUMMARY
          fi
