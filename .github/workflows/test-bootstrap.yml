name: Test Bootstrap Scripts

on:
  push:
    branches: [main, master]
    paths:
      - 'bootstrap.ps1'
      - 'bootstrap.sh'
      - 'test/**'
      - '.github/workflows/test-bootstrap.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Run integration tests with WSL'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # ===========================================
  # Security Scanning
  # ===========================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          # Skip node_modules and other large directories
          skip-dirs: 'node_modules,.pixi'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy for table output (summary)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          skip-dirs: 'node_modules,.pixi'

  # ===========================================
  # Tier 1: Unit Tests (Fast, runs on every commit)
  # ===========================================
  unit-tests-powershell:
    name: PowerShell Unit Tests
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module Pester -Force -SkipPublisherCheck
          Import-Module Pester
          Get-Module Pester | Select-Object Name, Version

      - name: Run PowerShell Linter
        shell: pwsh
        run: |
          Install-Module PSScriptAnalyzer -Force -SkipPublisherCheck
          $results = Invoke-ScriptAnalyzer -Path bootstrap.ps1 -Severity Error,Warning
          if ($results) {
            $results | Format-Table -AutoSize
            $errorCount = ($results | Where-Object { $_.Severity -eq 'Error' }).Count
            if ($errorCount -gt 0) {
              Write-Error "Found $errorCount error(s)"
              exit 1
            }
          }
          Write-Host "PSScriptAnalyzer passed" -ForegroundColor Green

      - name: Run Unit Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "test/unit"
          $config.Run.PassThru = $true
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "test-results.xml"
          $config.TestResult.OutputFormat = "NUnitXml"

          $result = Invoke-Pester -Configuration $config

          if ($result.FailedCount -gt 0) {
            Write-Error "Pester tests failed: $($result.FailedCount) failures"
            exit 1
          }

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: test-results.xml

  unit-tests-bash:
    name: Bash Script Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck on bootstrap.sh
        run: |
          shellcheck bootstrap.sh || true
          # Show results but don't fail yet (allow warnings)
          shellcheck -S error bootstrap.sh

      - name: Validate bash syntax
        run: bash -n bootstrap.sh

  # ===========================================
  # Tier 2: Integration Tests with WSL (setup-wsl action)
  # ===========================================
  integration-tests-wsl:
    name: WSL Integration Tests
    runs-on: windows-latest
    timeout-minutes: 30
    needs: [unit-tests-powershell, unit-tests-bash]
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_integration == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup WSL
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-22.04
          set-as-default: 'true'
          update: 'true'

      - name: Verify WSL is working
        shell: pwsh
        run: |
          Write-Host "WSL Status:"
          wsl --status

          Write-Host "`nWSL Distributions:"
          wsl --list --verbose

          Write-Host "`nTesting WSL command execution:"
          $result = wsl -- echo "Hello from WSL"
          Write-Host $result

      - name: Test bootstrap.sh syntax in WSL
        shell: pwsh
        run: |
          $winPath = Join-Path $env:GITHUB_WORKSPACE 'bootstrap.sh'
          if (-not (Test-Path $winPath)) {
            Write-Error "Expected file not found: $winPath"
          }

          # Convert e.g. D:\a\repo\repo\bootstrap.sh -> /mnt/d/a/repo/repo/bootstrap.sh
          
          $drive = $winPath.Substring(0,1).ToLower()
          $rest = $winPath.Substring(2) -replace '\\','/'
          $wslPath = "/mnt/$drive$rest"

          Write-Host "Validating bootstrap.sh syntax in WSL:" -ForegroundColor Cyan
          Write-Host "  Windows: $winPath"
          Write-Host "  WSL:     $wslPath"
          
          # Ensure WSL can see the file
          
          wsl -- test -f "$wslPath"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "WSL cannot access expected path: $wslPath"
          }

          # Windows checkouts can surface CRLF to WSL via /mnt/* (e.g. `do\r`).
          # Normalize CR away for syntax validation to avoid false negatives.
          
          $raw = Get-Content -Raw -LiteralPath $winPath
          if ($raw -match "`r") {
            Write-Warning "bootstrap.sh contains CR characters (CRLF). Normalizing for WSL syntax check."
          }

          wsl -- bash -lc "tr -d \"`$(printf '\r')\" < \"$wslPath\" | bash -n"
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          Write-Host "bootstrap.sh syntax is valid" -ForegroundColor Green

      - name: Test Nix installation in WSL
        shell: pwsh
        run: |
          # Install Nix in WSL Ubuntu
          wsl -- bash -c "curl -L https://nixos.org/nix/install | sh -s -- --daemon --yes" || true

          # Source nix and verify
          wsl -- bash -c "source ~/.nix-profile/etc/profile.d/nix.sh 2>/dev/null && nix --version" || echo "Nix installation test completed"

      - name: Run Integration Tests
        shell: pwsh
        run: |
          Install-Module Pester -Force -SkipPublisherCheck

          $config = New-PesterConfiguration
          $config.Run.Path = "test/integration"
          $config.Filter.Tag = "Integration"
          $config.Filter.ExcludeTag = "NixOS"  # Skip NixOS-specific tests
          $config.Run.PassThru = $true
          $config.Output.Verbosity = "Detailed"

          $result = Invoke-Pester -Configuration $config

          # Don't fail on integration test failures (informational)
          if ($result.FailedCount -gt 0) {
            Write-Warning "Some integration tests failed: $($result.FailedCount)"
          }

  # ===========================================
  # Tier 3: Full E2E (Self-hosted runner only)
  # ===========================================
  e2e-tests-self-hosted:
    name: E2E Tests (Self-Hosted WSL2)
    runs-on: [self-hosted, Windows, WSL2]
    timeout-minutes: 90
    needs: [unit-tests-powershell, unit-tests-bash]
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean previous test artifacts
        shell: pwsh
        run: |
          $distroName = "NixOS-ROS2-Test"
          $distros = wsl --list --quiet 2>$null
          if ($distros -contains $distroName) {
            Write-Host "Removing existing test distribution..."
            wsl --unregister $distroName
          }

          $testPath = "$env:TEMP\WSL-Test"
          if (Test-Path $testPath) {
            Remove-Item $testPath -Recurse -Force
          }

      - name: Run Full E2E Bootstrap
        shell: pwsh
        run: |
          .\bootstrap.ps1 `
            -DistroName "NixOS-ROS2-Test" `
            -InstallPath "$env:TEMP\WSL-Test\NixOS-ROS2-Test" `
            -DiskSizeGB 64 `
            -SwapSizeGB 4 `
            -Force

      - name: Run Integration Tests
        shell: pwsh
        run: |
          Install-Module Pester -Force -SkipPublisherCheck

          $config = New-PesterConfiguration
          $config.Run.Path = "test/integration"
          $config.Run.PassThru = $true
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "integration-results.xml"

          $result = Invoke-Pester -Configuration $config

          if ($result.FailedCount -gt 0) {
            Write-Error "Integration tests failed"
            exit 1
          }

      - name: Upload Integration Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: integration-results.xml

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          wsl --unregister NixOS-ROS2-Test 2>$null
          Remove-Item "$env:TEMP\WSL-Test" -Recurse -Force -ErrorAction SilentlyContinue

  # ===========================================
  # Summary Job
  # ===========================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests-powershell, unit-tests-bash, integration-tests-wsl]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.unit-tests-powershell.result }}" == "success" ]; then
            echo "✅ PowerShell Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ PowerShell Unit Tests: ${{ needs.unit-tests-powershell.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.unit-tests-bash.result }}" == "success" ]; then
            echo "✅ Bash Validation: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Bash Validation: ${{ needs.unit-tests-bash.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.integration-tests-wsl.result }}" == "success" ]; then
            echo "✅ WSL Integration: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration-tests-wsl.result }}" == "skipped" ]; then
            echo "⏭️ WSL Integration: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ WSL Integration: ${{ needs.integration-tests-wsl.result }}" >> $GITHUB_STEP_SUMMARY
          fi
