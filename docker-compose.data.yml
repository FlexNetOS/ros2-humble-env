# =============================================================================
# Data & Query Services - Layer 11
# =============================================================================
# P2-011: MindsDB - AI/ML database layer for ML predictions via SQL
# P3-003: Neo4j - Graph database for knowledge graphs and relationship modeling
# =============================================================================
#
# Usage:
#   docker network create agentic-network 2>/dev/null || true
#   docker compose -f docker-compose.data.yml up -d
#
# Endpoints:
#   MindsDB HTTP API:   http://localhost:47334
#   MindsDB MySQL:      mysql://localhost:47335
#   MindsDB MongoDB:    mongodb://localhost:47336
#   MindsDB Studio:     http://localhost:47334 (Web UI)
#   Neo4j Browser:      http://localhost:7474
#   Neo4j Bolt:         bolt://localhost:7687
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # MindsDB - AI/ML Database Layer
  # ---------------------------------------------------------------------------
  # https://github.com/mindsdb/mindsdb
  # AI-powered predictions and automation via SQL:
  # - ML model integration via SQL queries
  # - Time-series forecasting
  # - NLP tasks (sentiment, classification, Q&A)
  # - AutoML capabilities
  # - Multi-source data integration (Postgres, MySQL, MongoDB, APIs)
  # ---------------------------------------------------------------------------
  mindsdb:
    image: mindsdb/mindsdb:latest
    container_name: mindsdb
    ports:
      - "47334:47334"  # HTTP API & Web UI
      - "47335:47335"  # MySQL protocol
      - "47336:47336"  # MongoDB protocol
    environment:
      # MindsDB Server Configuration
      MINDSDB_STORAGE_DIR: /mindsdb/storage

      # PostgreSQL metadata store connection
      # MindsDB uses this to store its own metadata, models, and configurations
      MINDSDB_DB_SERVICE_HOST: ${MINDSDB_DB_HOST:-mindsdb-db}
      MINDSDB_DB_SERVICE_PORT: ${MINDSDB_DB_PORT:-5432}
      MINDSDB_DB_SERVICE_USER: ${MINDSDB_DB_USER:-mindsdb}
      MINDSDB_DB_SERVICE_PASSWORD: ${MINDSDB_DB_PASSWORD:-changeme}
      MINDSDB_DB_SERVICE_DATABASE: ${MINDSDB_DB_NAME:-mindsdb}

      # API Configuration
      MINDSDB_API_PORT: 47334
      MINDSDB_MYSQL_PORT: 47335
      MINDSDB_MONGODB_PORT: 47336

      # Security (should be changed in production)
      MINDSDB_API_KEY: ${MINDSDB_API_KEY:-changeme}

      # Optional: Connect to existing Postgres data sources
      # These can be configured via SQL commands in MindsDB after startup
      # Example: CREATE DATABASE mlflow_data WITH ENGINE = "postgres", PARAMETERS = {...}
    volumes:
      - mindsdb_storage:/mindsdb/storage
      - mindsdb_cache:/root/.mindsdb
    depends_on:
      mindsdb-db:
        condition: service_healthy
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:47334/api/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4gb
          cpus: '2.0'
        reservations:
          memory: 2gb
          cpus: '1.0'

  # ---------------------------------------------------------------------------
  # MindsDB PostgreSQL Database - Metadata Store
  # ---------------------------------------------------------------------------
  # Stores MindsDB's internal metadata:
  # - Model definitions and configurations
  # - Data source connections
  # - Prediction history
  # - User settings and preferences
  # ---------------------------------------------------------------------------
  mindsdb-db:
    image: postgres:17.2-alpine
    container_name: mindsdb-db
    environment:
      POSTGRES_DB: ${MINDSDB_DB_NAME:-mindsdb}
      POSTGRES_USER: ${MINDSDB_DB_USER:-mindsdb}
      POSTGRES_PASSWORD: ${MINDSDB_DB_PASSWORD:-changeme}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8"
    volumes:
      - mindsdb_db_data:/var/lib/postgresql/data
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${MINDSDB_DB_USER:-mindsdb} -d ${MINDSDB_DB_NAME:-mindsdb}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1gb
        reservations:
          memory: 256mb

  # ---------------------------------------------------------------------------
  # Neo4j - Graph Database
  # ---------------------------------------------------------------------------
  # https://github.com/neo4j/neo4j
  # Graph database for knowledge graphs and relationship modeling:
  # - Knowledge graph storage and querying
  # - Relationship-based data modeling
  # - Cypher query language for graph traversal
  # - ACID transactions
  # - Integration with ML pipelines for graph analytics
  # - RAG (Retrieval Augmented Generation) support
  # ---------------------------------------------------------------------------
  neo4j:
    image: neo4j:5-community
    container_name: neo4j
    ports:
      - "7474:7474"  # HTTP (Browser UI)
      - "7687:7687"  # Bolt protocol
    environment:
      # Authentication
      # Format: NEO4J_AUTH=username/password or "none" to disable
      # IMPORTANT: Change password on first login if using default
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-changeme}

      # Memory Configuration
      # Initial heap size (should be same as max for production)
      NEO4J_server_memory_heap_initial__size: ${NEO4J_HEAP_INITIAL:-512m}
      NEO4J_server_memory_heap_max__size: ${NEO4J_HEAP_MAX:-1g}
      NEO4J_server_memory_pagecache_size: ${NEO4J_PAGECACHE:-512m}

      # Security Configuration
      NEO4J_dbms_security_auth__minimum__password__length: 8
      NEO4J_dbms_security_allow__csv__import__from__file__urls: "true"

      # Network Configuration
      NEO4J_server_bolt_listen__address: 0.0.0.0:7687
      NEO4J_server_http_listen__address: 0.0.0.0:7474

      # Database Configuration
      NEO4J_dbms_default__database: ${NEO4J_DEFAULT_DB:-neo4j}

      # Plugins (uncomment as needed)
      # NEO4J_dbms_security_procedures_unrestricted: apoc.*,gds.*
      # NEO4JLABS_PLUGINS: '["apoc", "graph-data-science"]'

      # Performance Tuning
      NEO4J_dbms_query__cache__size: 1000
      NEO4J_dbms_tx__log__rotation__retention__policy: "7 days"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-changeme} 'RETURN 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2gb
          cpus: '2.0'
        reservations:
          memory: 1gb
          cpus: '0.5'

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mindsdb_storage:
    driver: local
  mindsdb_cache:
    driver: local
  mindsdb_db_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  agentic-network:
    external: true
    name: agentic-network
