# =============================================================================
# Identity & Access Management Stack
# =============================================================================
# BUILDKIT_STARTER_SPEC.md Layer 5: Identity & Policy
#
# Components:
#   - Step-CA: Certificate Authority for mTLS (ARIA P1-005, SEC-003)
#   - Keycloak: OIDC identity provider
#   - PostgreSQL: Keycloak database
#   - Vaultwarden: Bitwarden-compatible password vault (optional)
#
# Usage:
#   # Initialize CA first (one-time):
#   ./scripts/init-step-ca.sh
#
#   # Start services:
#   docker-compose -f docker-compose.identity.yml up -d
#
# Access:
#   - Step-CA: https://localhost:9000 (mTLS certificate authority)
#   - Keycloak Admin: http://localhost:8080/admin (use KEYCLOAK_ADMIN env vars)
#   - Vaultwarden: http://localhost:8081 (use VAULTWARDEN_ADMIN_TOKEN env var)
#
# mTLS Documentation:
#   - See docs/MTLS_SETUP.md for complete mTLS configuration guide
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Step-CA - Certificate Authority for mTLS
  # ---------------------------------------------------------------------------
  # https://github.com/smallstep/certificates
  # Provides PKI infrastructure for inter-service mTLS (P1-005, SEC-003)
  step-ca:
    image: smallstep/step-ca:0.27.5
    container_name: step-ca
    environment:
      # Docker entrypoint password (must match init-step-ca.sh)
      DOCKER_STEPCA_INIT_PASSWORD_FILE: /run/secrets/step-ca-password
      # CA configuration
      DOCKER_STEPCA_INIT_NAME: "ARIA Development CA"
      DOCKER_STEPCA_INIT_DNS_NAMES: "step-ca,localhost"
      DOCKER_STEPCA_INIT_PROVISIONER_NAME: "admin"
      # Use existing configuration if available
      DOCKER_STEPCA_INIT_SKIP_CONFIRM: "true"
    volumes:
      # CA configuration and PKI
      - ./config/step-ca:/home/step
      # Password file (created by init-step-ca.sh)
      - ./config/step-ca/secrets/password.txt:/run/secrets/step-ca-password:ro
    ports:
      - "9000:9000"
    networks:
      - identity-network
    healthcheck:
      test: ["CMD", "step", "ca", "health", "--ca-url=https://localhost:9000", "--root=/home/step/pki/root_ca.crt"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Keycloak - OIDC Identity Provider
  # ---------------------------------------------------------------------------
  # https://github.com/keycloak/keycloak
  # Provides OAuth2/OIDC authentication for all services
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: keycloak
    command: start-dev
    environment:
      # Admin credentials (loaded from environment variables)
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-changeme}
      # Database connection
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/${KEYCLOAK_DB_NAME:-keycloak}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-changeme}
      # Development settings
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      # Health endpoint
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      # mTLS Configuration (SEC-003)
      # Uncomment when service certificates are generated
      # KC_HTTPS_CERTIFICATE_FILE: /etc/certs/keycloak.crt
      # KC_HTTPS_CERTIFICATE_KEY_FILE: /etc/certs/keycloak.key
      # KC_HTTPS_CLIENT_AUTH: request
      # KC_HTTPS_TRUST_STORE_FILE: /etc/ssl/certs/aria-root-ca.crt
    volumes:
      # mTLS certificates (mount when available)
      # - ./config/step-ca/pki/root_ca.crt:/etc/ssl/certs/aria-root-ca.crt:ro
      # - ./data/certs/keycloak:/etc/certs:ro
    ports:
      - "8080:8080"
      - "8443:8443"
    depends_on:
      keycloak-db:
        condition: service_healthy
      step-ca:
        condition: service_healthy
    networks:
      - identity-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\n\r\n' >&3;timeout --signal=QUIT 1 cat <&3 | grep -q '200 OK'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PostgreSQL - Keycloak Database
  # ---------------------------------------------------------------------------
  keycloak-db:
    image: postgres:17.2-alpine
    container_name: keycloak-db
    environment:
      POSTGRES_DB: ${KEYCLOAK_DB_NAME:-keycloak}
      POSTGRES_USER: ${KEYCLOAK_DB_USER:-keycloak}
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-changeme}
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    networks:
      - identity-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KEYCLOAK_DB_USER:-keycloak} -d ${KEYCLOAK_DB_NAME:-keycloak}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Vaultwarden - Bitwarden-Compatible Password Vault
  # ---------------------------------------------------------------------------
  # https://github.com/dani-garcia/vaultwarden
  # Self-hosted password manager for human secrets and device credentials
  vaultwarden:
    image: vaultwarden/server:1.32.5
    container_name: vaultwarden
    environment:
      # Disable signups in production
      SIGNUPS_ALLOWED: "true"
      # Admin token (loaded from environment variables)
      ADMIN_TOKEN: ${VAULTWARDEN_ADMIN_TOKEN:-changeme}
      # WebSocket notifications
      WEBSOCKET_ENABLED: "true"
      # Database (SQLite by default, can use PostgreSQL)
      DATABASE_URL: /data/db.sqlite3
      # Domain for email verification
      DOMAIN: "http://localhost:8081"
      # mTLS Configuration (SEC-003)
      # Uncomment when service certificates are generated
      # ROCKET_TLS: '{certs="/etc/certs/vaultwarden.crt",key="/etc/certs/vaultwarden.key"}'
    volumes:
      - vaultwarden-data:/data
      # mTLS certificates (mount when available)
      # - ./config/step-ca/pki/root_ca.crt:/etc/ssl/certs/aria-root-ca.crt:ro
      # - ./data/certs/vaultwarden:/etc/certs:ro
    ports:
      - "8081:80"
      - "3012:3012"  # WebSocket
    depends_on:
      step-ca:
        condition: service_healthy
    networks:
      - identity-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

networks:
  identity-network:
    driver: bridge

volumes:
  keycloak-db-data:
    driver: local
  vaultwarden-data:
    driver: local
