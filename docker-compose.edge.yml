
services:
  # Kong Gateway - North-South edge ingress (P0-003)
  kong-database:
    image: postgres:17.2-alpine
    container_name: kong-database
    environment:
      POSTGRES_USER: ${KONG_DB_USER:-kong}
      POSTGRES_DB: ${KONG_DB_NAME:-kong}
      POSTGRES_PASSWORD: ${KONG_DB_PASSWORD:-changeme}
      # Create multiple databases for Kong and Konga
      POSTGRES_MULTIPLE_DATABASES: ${KONG_DB_NAME:-kong},${KONGA_DB_NAME:-konga}
    volumes:
      - kong-db-data:/var/lib/postgresql/data
      - ./scripts/init-multi-db.sh:/docker-entrypoint-initdb.d/init-multi-db.sh:ro
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${KONG_DB_USER:-kong}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    labels:
      com.aria.component: "edge"
      com.aria.service: "kong-database"
      com.aria.priority: "P0-003"

  kong-migrations:
    image: kong:3.9.0-alpine
    container_name: kong-migrations
    command: kong migrations bootstrap
    depends_on:
      kong-database:
        condition: service_healthy
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: ${KONG_DB_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD:-changeme}
      KONG_PG_DATABASE: ${KONG_DB_NAME:-kong}
    networks:
      - agentic-network
    restart: on-failure
    labels:
      com.aria.component: "edge"
      com.aria.service: "kong-migrations"
      com.aria.priority: "P0-003"

  kong:
    image: kong:3.9.0-alpine
    container_name: kong
    depends_on:
      kong-database:
        condition: service_healthy
      kong-migrations:
        condition: service_completed_successfully
    environment:
      # Database configuration
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: ${KONG_DB_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD:-changeme}
      KONG_PG_DATABASE: ${KONG_DB_NAME:-kong}

      # Logging configuration
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_LOG_LEVEL: ${KONG_LOG_LEVEL:-info}

      # Admin API configuration
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_ADMIN_GUI_URL: http://localhost:8002

      # Proxy configuration
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl

      # Performance tuning
      KONG_NGINX_WORKER_PROCESSES: ${KONG_WORKER_PROCESSES:-auto}
      KONG_NGINX_HTTP_KEEPALIVE_TIMEOUT: 75s
      KONG_UPSTREAM_KEEPALIVE_POOL_SIZE: 60
      KONG_UPSTREAM_KEEPALIVE_MAX_REQUESTS: 100
      KONG_UPSTREAM_KEEPALIVE_IDLE_TIMEOUT: 60s

      # Security
      KONG_REAL_IP_HEADER: X-Real-IP
      KONG_TRUSTED_IPS: 0.0.0.0/0,::/0

      # Feature flags
      KONG_ENABLED: ${KONG_ENABLED:-true}
    ports:
      - "${KONG_PROXY_PORT:-8000}:8000"      # Proxy HTTP
      - "${KONG_PROXY_SSL_PORT:-8443}:8443"  # Proxy HTTPS
      - "${KONG_ADMIN_PORT:-8001}:8001"      # Admin API HTTP
      - "${KONG_ADMIN_SSL_PORT:-8444}:8444"  # Admin API HTTPS
      - "${KONG_MANAGER_PORT:-8002}:8002"    # Kong Manager (GUI)
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    labels:
      com.aria.component: "edge"
      com.aria.service: "kong-gateway"
      com.aria.priority: "P0-003"
      com.aria.type: "api-gateway"

  # AgentGateway - Agent/MCP traffic plane (P0-004)
  agentgateway:
    image: ${AGENTGATEWAY_IMAGE:-agentgateway/agentgateway:0.2.0}
    container_name: agentgateway
    ports:
      - "${AGENTGATEWAY_API_PORT:-8090}:8090"      # Main API
      - "${AGENTGATEWAY_ADMIN_PORT:-8091}:8091"    # Admin API
      - "${AGENTGATEWAY_METRICS_PORT:-8092}:8092"  # Metrics
    environment:
      # Core configuration
      AG_CONFIG_FILE: /config/config.yaml
      AG_LOG_LEVEL: ${AG_LOG_LEVEL:-info}
      AG_LOG_FORMAT: ${AG_LOG_FORMAT:-json}

      # Server configuration
      AG_UPSTREAM_TIMEOUT: ${AG_UPSTREAM_TIMEOUT:-30s}
      AG_MAX_CONNECTIONS: ${AG_MAX_CONNECTIONS:-1000}
      AG_READ_TIMEOUT: ${AG_READ_TIMEOUT:-30s}
      AG_WRITE_TIMEOUT: ${AG_WRITE_TIMEOUT:-30s}

      # LocalAI integration
      AG_LOCALAI_URL: ${AG_LOCALAI_URL:-http://localai:8080}
      AG_LOCALAI_TIMEOUT: ${AG_LOCALAI_TIMEOUT:-30s}

      # Kong integration for north-south traffic
      AG_KONG_ADMIN_URL: ${AG_KONG_ADMIN_URL:-http://kong:8001}
      AG_KONG_PROXY_URL: ${AG_KONG_PROXY_URL:-http://kong:8000}

      # MCP protocol support
      AG_MCP_ENABLED: ${AG_MCP_ENABLED:-true}
      AG_MCP_TRANSPORT: ${AG_MCP_TRANSPORT:-stdio,http}
      AG_MCP_MAX_MESSAGE_SIZE: ${AG_MCP_MAX_MESSAGE_SIZE:-10485760}

      # Rate limiting
      AG_RATE_LIMIT_ENABLED: ${AG_RATE_LIMIT_ENABLED:-true}
      AG_RATE_LIMIT_RPS: ${AG_RATE_LIMIT_RPS:-100}
      AG_RATE_LIMIT_BURST: ${AG_RATE_LIMIT_BURST:-200}

      # Circuit breaker
      AG_CIRCUIT_BREAKER_ENABLED: ${AG_CIRCUIT_BREAKER_ENABLED:-true}
      AG_CIRCUIT_BREAKER_THRESHOLD: ${AG_CIRCUIT_BREAKER_THRESHOLD:-5}

      # Metrics
      AG_METRICS_ENABLED: ${AG_METRICS_ENABLED:-true}
      AG_METRICS_NAMESPACE: ${AG_METRICS_NAMESPACE:-agentgateway}

      # Feature flags
      AGENTGATEWAY_ENABLED: ${AGENTGATEWAY_ENABLED:-true}
    volumes:
      - ./config/agentgateway:/config:ro
      - agentgateway-cache:/cache
      - agentgateway-logs:/logs
    depends_on:
      kong:
        condition: service_healthy
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8090/health || curl -f http://localhost:8090/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    labels:
      com.aria.component: "edge"
      com.aria.service: "agentgateway"
      com.aria.priority: "P0-004"
      com.aria.type: "agent-gateway"
      com.aria.mcp: "enabled"

  # Konga database preparation
  konga-prepare:
    image: pantsel/konga:0.14.9
    container_name: konga-prepare
    command: "-c prepare -a postgres -u postgresql://${KONG_DB_USER:-kong}:${KONG_DB_PASSWORD:-changeme}@kong-database:5432/${KONGA_DB_NAME:-konga}"
    depends_on:
      kong-database:
        condition: service_healthy
    networks:
      - agentic-network
    restart: on-failure
    labels:
      com.aria.component: "edge"
      com.aria.service: "konga-prepare"
      com.aria.priority: "P0-003"

  # Konga - Kong Admin UI (optional)
  konga:
    image: pantsel/konga:0.14.9
    container_name: konga
    depends_on:
      kong:
        condition: service_healthy
      konga-prepare:
        condition: service_completed_successfully
    environment:
      NODE_ENV: ${KONGA_ENV:-production}
      DB_ADAPTER: postgres
      DB_HOST: kong-database
      DB_PORT: 5432
      DB_USER: ${KONG_DB_USER:-kong}
      DB_PASSWORD: ${KONG_DB_PASSWORD:-changeme}
      DB_DATABASE: ${KONGA_DB_NAME:-konga}
      KONGA_HOOK_TIMEOUT: 120000
      KONGA_LOG_LEVEL: ${KONGA_LOG_LEVEL:-info}
    ports:
      - "${KONGA_PORT:-1337}:1337"
    networks:
      - agentic-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:1337"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    labels:
      com.aria.component: "edge"
      com.aria.service: "konga-ui"
      com.aria.priority: "P0-003"

volumes:
  kong-db-data:
    driver: local
    labels:
      com.aria.component: "edge"
      com.aria.service: "kong-database"
  agentgateway-cache:
    driver: local
    labels:
      com.aria.component: "edge"
      com.aria.service: "agentgateway"
  agentgateway-logs:
    driver: local
    labels:
      com.aria.component: "edge"
      com.aria.service: "agentgateway"

networks:
  agentic-network:
    external: true
    name: agentic-network

# Usage:
# 1. Create network: docker network create agentic-network
# 2. Create config directory: mkdir -p config/agentgateway
# 3. Start services: docker-compose -f docker-compose.edge.yml up -d
# 4. Verify Kong: curl http://localhost:8001/status
# 5. Verify AgentGateway: curl http://localhost:8090/health
# 6. Access Kong Manager: http://localhost:8002
# 7. Access Konga: http://localhost:1337
#
# Kong API Gateway configuration:
# - Add service: curl -i -X POST http://localhost:8001/services --data name=localai --data url=http://localai:8080
# - Add route: curl -i -X POST http://localhost:8001/services/localai/routes --data paths[]=/ai
# - Test: curl http://localhost:8000/ai/v1/models
#
# AgentGateway configuration:
# - Routes agent traffic to LocalAI through Kong
# - Supports MCP protocol for agent communication
# - Provides metrics and observability at :8092/metrics
